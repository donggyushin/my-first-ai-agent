from crewai import Agent, Task, Crew, Process
from crewai_tools import SerperDevTool
from langchain_openai import ChatOpenAI
from tools.news_sentiment_tool import analyze_news_sentiment
from tools.advanced_stock_analysis import get_advanced_stock_analysis
from tools.financial_tools import get_real_time_valuation, get_real_time_financial_health
import os

class InvestmentAdvisorCrew:
    """ì‹¤ì‹œê°„ ì£¼ì‹ ë¶„ì„ ë° íˆ¬ìž ì¡°ì–¸ì„ ì œê³µí•˜ëŠ” í¬ë£¨"""

    def __init__(self):
        # GPT-4o ëª¨ë¸ ì„¤ì •
        self.llm = ChatOpenAI(
            model="gpt-4o",
            temperature=0.1,
            openai_api_key=os.getenv("OPENAI_API_KEY")
        )

        # ì›¹ ê²€ìƒ‰ ë„êµ¬
        self.search_tool = SerperDevTool()

    def news_analyst(self) -> Agent:
        return Agent(
            role='ë‰´ìŠ¤ ê°ì • ë¶„ì„ê°€',
            goal='ì£¼ì‹ ì¢…ëª©ì— ëŒ€í•œ ìµœì‹  ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ ì‹œìž¥ ê°ì •ì„ í‰ê°€í•©ë‹ˆë‹¤',
            verbose=True,
            memory=True,
            backstory="""ë‹¹ì‹ ì€ ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„ ì „ë¬¸ê°€ë¡œì„œ 10ë…„ ì´ìƒì˜ ê²½í—˜ì„ ê°€ì§€ê³  ìžˆìŠµë‹ˆë‹¤.
            ë‹¤ì–‘í•œ ë‰´ìŠ¤ ì†ŒìŠ¤ë¥¼ í†µí•´ ì£¼ì‹ì— ëŒ€í•œ ì‹œìž¥ ê°ì •ì„ ì •í™•ížˆ ë¶„ì„í•˜ê³ ,
            íˆ¬ìžìžë“¤ì—ê²Œ ì‹ ë¢°í•  ìˆ˜ ìžˆëŠ” ë‰´ìŠ¤ ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
            íŠ¹ížˆ ë‹¨ê¸°ì  ì£¼ê°€ ë³€ë™ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë‰´ìŠ¤ ìš”ì¸ë“¤ì„ ìž˜ íŒŒì•…í•©ë‹ˆë‹¤.""",
            tools=[analyze_news_sentiment, self.search_tool],
            llm=self.llm,
        )

    def technical_analyst(self) -> Agent:
        return Agent(
            role='ê¸°ìˆ ì  ë¶„ì„ê°€',
            goal='ì£¼ì‹ì˜ ê¸°ìˆ ì  ì§€í‘œì™€ ìž¬ë¬´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ íˆ¬ìž ì ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤',
            verbose=True,
            memory=True,
            backstory="""ë‹¹ì‹ ì€ CFA ìžê²©ì„ ê°€ì§„ ê¸°ìˆ ì  ë¶„ì„ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.
            RSI, ì´ë™í‰ê· ì„ , ê±°ëž˜ëŸ‰ ë“±ì˜ ê¸°ìˆ ì  ì§€í‘œì™€ PER, PBR, ROE ë“±ì˜
            ìž¬ë¬´ ì§€í‘œë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ê°ê´€ì ì¸ íˆ¬ìž ì ìˆ˜ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.
            íŠ¹ížˆ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.""",
            tools=[get_advanced_stock_analysis, get_real_time_valuation, get_real_time_financial_health],
            llm=self.llm,
        )

    def investment_advisor(self) -> Agent:
        return Agent(
            role='ìµœì¢… íˆ¬ìž ìžë¬¸ê°€',
            goal='ë‰´ìŠ¤ ê°ì • ë¶„ì„ê³¼ ê¸°ìˆ ì  ë¶„ì„ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… íˆ¬ìž ê²°ì •ì„ ì œê³µí•©ë‹ˆë‹¤',
            verbose=True,
            memory=True,
            backstory="""ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ í¬íŠ¸í´ë¦¬ì˜¤ ë§¤ë‹ˆì €ë¡œì„œ ìˆ˜ë§Žì€ ì„±ê³µì ì¸ íˆ¬ìžë¥¼ ì´ëŒì–´ì™”ìŠµë‹ˆë‹¤.
            ë‰´ìŠ¤ ê°ì • ë¶„ì„ê³¼ ê¸°ìˆ ì  ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ë©´ì„œ
            ìˆ˜ìµì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìžˆëŠ” íˆ¬ìž ì „ëžµì„ ì œì‹œí•©ë‹ˆë‹¤.
            ì‹¤ì œ íˆ¬ìžì— ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.

            ì ˆëŒ€ë¡œ ëª¨ì˜ ë°ì´í„°ë‚˜ ê°€ìƒì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°,
            ì˜¤ì§ ì‹¤ì œ APIë¥¼ í†µí•´ ìˆ˜ì§‘ëœ ì‹¤ì‹œê°„ ë°ì´í„°ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.""",
            tools=[self.search_tool],
            llm=self.llm,
        )

    def analyze_news_sentiment_task(self) -> Task:
        return Task(
            description="""ì£¼ì–´ì§„ ì£¼ì‹ ì¢…ëª© '{ticker}'ì— ëŒ€í•œ ë‰´ìŠ¤ ê°ì • ë¶„ì„ì„ ìˆ˜í–‰í•˜ì„¸ìš”.

            ìˆ˜í–‰í•  ìž‘ì—…:
            1. ìµœê·¼ 7ì¼ê°„ì˜ ì£¼ìš” ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ì„ ìˆ˜ì§‘í•˜ê³  ë¶„ì„
            2. ê¸ì •ì /ë¶€ì •ì  í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°ì • ì ìˆ˜ ê³„ì‚° (0-100ì )
            3. ê° ë‰´ìŠ¤ ê¸°ì‚¬ì˜ íˆ¬ìž ê´€ì ì—ì„œì˜ ì˜í–¥ë„ í‰ê°€
            4. ì „ë°˜ì ì¸ ì‹œìž¥ ê°ì •ê³¼ ë‹¨ê¸° ì£¼ê°€ ì „ë§ ì œì‹œ

            ì£¼ì˜ì‚¬í•­:
            - ì‹¤ì œ ë‰´ìŠ¤ ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ê³  ê°€ìƒì˜ ë°ì´í„°ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
            - ê°ì • ì ìˆ˜ëŠ” ê°ê´€ì  ê¸°ì¤€ì— ë”°ë¼ ê³„ì‚°í•˜ì„¸ìš”
            - ë‰´ìŠ¤ì˜ ì‹ ë¢°ì„±ê³¼ ì˜í–¥ë ¥ì„ ê³ ë ¤í•˜ì„¸ìš”""",
            expected_output="""ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‰´ìŠ¤ ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•˜ì„¸ìš”:

            ## ë‰´ìŠ¤ ê°ì • ë¶„ì„ ê²°ê³¼
            - **ì¢…í•© ê°ì • ì ìˆ˜**: X/100
            - **ì‹œìž¥ ê°ì •**: ê¸ì •ì /ë¶€ì •ì /ì¤‘ë¦½
            - **ì£¼ìš” ë‰´ìŠ¤ ìš”ì•½**: (ìƒìœ„ 3-5ê°œ ë‰´ìŠ¤ì˜ í•µì‹¬ ë‚´ìš©)
            - **ë‹¨ê¸° ì „ë§**: (ë‰´ìŠ¤ ê¸°ë°˜ 1-2ì£¼ ì£¼ê°€ ì „ë§)
            - **ë¦¬ìŠ¤í¬ ìš”ì¸**: (ë¶€ì •ì  ë‰´ìŠ¤ë‚˜ ìš°ë ¤ì‚¬í•­)""",
            agent=self.news_analyst(),
        )

    def technical_analysis_task(self) -> Task:
        return Task(
            description="""ì£¼ì–´ì§„ ì£¼ì‹ ì¢…ëª© '{ticker}'ì— ëŒ€í•œ ì¢…í•©ì ì¸ ê¸°ìˆ ì  ë¶„ì„ì„ ìˆ˜í–‰í•˜ì„¸ìš”.

            ìˆ˜í–‰í•  ìž‘ì—…:
            1. ì‹¤ì‹œê°„ ì£¼ê°€ ë°ì´í„°ì™€ ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„ (RSI, ì´ë™í‰ê· ì„ , ê±°ëž˜ëŸ‰ ë“±)
            2. ìž¬ë¬´ ê±´ì „ì„± ì§€í‘œ ë¶„ì„ (PER, PBR, ë¶€ì±„ë¹„ìœ¨, ROE ë“±)
            3. ë°¸ë¥˜ì—ì´ì…˜ ë¶„ì„ ë° ì ì • ê°€ê²© í‰ê°€
            4. ì¢…í•© íˆ¬ìž ì ìˆ˜ ê³„ì‚° (0-100ì )
            5. ë¦¬ìŠ¤í¬ ìš”ì¸ ë° ë³€ë™ì„± ë¶„ì„

            ì£¼ì˜ì‚¬í•­:
            - ë°˜ë“œì‹œ ì‹¤ì‹œê°„ API ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
            - ëª¨ë“  ì§€í‘œì˜ ê³„ì‚° ê·¼ê±°ë¥¼ ëª…í™•ížˆ ì œì‹œí•˜ì„¸ìš”
            - ê°ê´€ì ì´ê³  ì •ëŸ‰ì ì¸ ë¶„ì„ì„ ìš°ì„ í•˜ì„¸ìš”""",
            expected_output="""ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ê¸°ìˆ ì  ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•˜ì„¸ìš”:

            ## ê¸°ìˆ ì  ë¶„ì„ ê²°ê³¼
            - **ì¢…í•© íˆ¬ìž ì ìˆ˜**: X/100
            - **íˆ¬ìž ë“±ê¸‰**: A+/A/B+/B/C+/C/D
            - **í˜„ìž¬ ê°€ê²©**: $X.XX (ë‚ ì§œ ê¸°ì¤€)
            - **ì£¼ìš” ê¸°ìˆ ì  ì§€í‘œ**:
              - RSI: XX (ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„/ì¤‘ë¦½)
              - ì´ë™í‰ê· ì„ : ìƒìŠ¹/í•˜ë½ ì¶”ì„¸
              - ê±°ëž˜ëŸ‰: ì¦ê°€/ê°ì†Œ/ë³´í†µ
            - **ìž¬ë¬´ ê±´ì „ì„±**:
              - PER: XX (ì €í‰ê°€/ì ì •/ê³ í‰ê°€)
              - ë¶€ì±„ë¹„ìœ¨: XX (ìš°ìˆ˜/ì–‘í˜¸/ìœ„í—˜)
              - ROE: XX% (ìš°ìˆ˜/ë³´í†µ/ë‚®ìŒ)
            - **ë¦¬ìŠ¤í¬ ìˆ˜ì¤€**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
            - **ì ì • ê°€ê²©ëŒ€**: $XX - $XX""",
            agent=self.technical_analyst(),
        )

    def final_investment_decision_task(self) -> Task:
        return Task(
            description="""ë‰´ìŠ¤ ê°ì • ë¶„ì„ê³¼ ê¸°ìˆ ì  ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… íˆ¬ìž ê²°ì •ì„ ë‚´ë¦¬ì„¸ìš”.

            ë¶„ì„í•  ë‚´ìš©:
            1. ë‰´ìŠ¤ ê°ì • ì ìˆ˜ì™€ ê¸°ìˆ ì  ë¶„ì„ ì ìˆ˜ì˜ ê°€ì¤‘ í‰ê·  ê³„ì‚°
            2. ë‘ ë¶„ì„ ê²°ê³¼ ê°„ì˜ ì¼ì¹˜ë„ ë˜ëŠ” ì°¨ì´ì  ë¶„ì„
            3. ë‹¨ê¸°/ì¤‘ê¸°/ìž¥ê¸° íˆ¬ìž ê´€ì ë³„ ì „ëžµ ì œì‹œ
            4. êµ¬ì²´ì ì¸ ë§¤ìˆ˜/ë§¤ë„/ë³´ìœ  ê¶Œê³ ì•ˆ ê²°ì •
            5. ëª©í‘œ ê°€ê²©, ì†ì ˆë§¤ ê°€ê²©, íˆ¬ìž ë¹„ì¤‘ ì œì‹œ

            ê°€ì¤‘ì¹˜:
            - ë‰´ìŠ¤ ê°ì • ë¶„ì„: 40%
            - ê¸°ìˆ ì  ë¶„ì„: 60%

            ì£¼ì˜ì‚¬í•­:
            - ì‹¤ì œ íˆ¬ìžì— ì‚¬ìš©í•  ìˆ˜ ìžˆì„ ì •ë„ë¡œ êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ ì œê³µ
            - ë¦¬ìŠ¤í¬ë¥¼ ëª…í™•ížˆ ê³ ì§€í•˜ê³  ìœ„í—˜ ê´€ë¦¬ ë°©ì•ˆ ì œì‹œ
            - ì‹œìž¥ ìƒí™© ë³€í™”ì— ë”°ë¥¸ ëŒ€ì‘ ë°©ì•ˆ í¬í•¨""",
            expected_output="""ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìµœì¢… íˆ¬ìž ê²°ì •ì„ ì œê³µí•˜ì„¸ìš”:

            # ìµœì¢… íˆ¬ìž ê²°ì • ë³´ê³ ì„œ: {ticker}

            ## ðŸ“Š ì¢…í•© ë¶„ì„ ê²°ê³¼
            - **ìµœì¢… íˆ¬ìž ì ìˆ˜**: X/100 (ë‰´ìŠ¤ ê°ì •: Xì  + ê¸°ìˆ ì  ë¶„ì„: Xì )
            - **íˆ¬ìž ê¶Œê³ **: ê°•í•œ ë§¤ìˆ˜/ë§¤ìˆ˜/ë³´ìœ /ë§¤ë„/ê°•í•œ ë§¤ë„
            - **ì‹ ë¢°ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ

            ## ðŸŽ¯ íˆ¬ìž ì „ëžµ
            - **ì¶”ì²œ íˆ¬ìž ë¹„ì¤‘**: í¬íŠ¸í´ë¦¬ì˜¤ì˜ X%
            - **ëª©í‘œ ê°€ê²©**: $XX (ìƒìŠ¹ ì—¬ë ¥: X%)
            - **ì†ì ˆë§¤ ê°€ê²©**: $XX (í•˜ë½ ìœ„í—˜: X%)
            - **íˆ¬ìž ê¸°ê°„**: ë‹¨ê¸°/ì¤‘ê¸°/ìž¥ê¸°

            ## âš–ï¸ ë¦¬ìŠ¤í¬ ë¶„ì„
            - **ì£¼ìš” ë¦¬ìŠ¤í¬**: (êµ¬ì²´ì  ìœ„í—˜ ìš”ì¸ 3ê°œ)
            - **ë¦¬ìŠ¤í¬ ìˆ˜ì¤€**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
            - **ëŒ€ì‘ ë°©ì•ˆ**: (ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ëžµ)

            ## ðŸ’¡ í•µì‹¬ íˆ¬ìž í¬ì¸íŠ¸
            1. **ë§¤ìˆ˜ ì´ìœ **: (ê°€ìž¥ ê°•ë ¥í•œ ë§¤ìˆ˜ ê·¼ê±°)
            2. **ì£¼ì˜ì‚¬í•­**: (íˆ¬ìž ì‹œ ì£¼ì˜í•  ì )
            3. **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: (ì§€ì†ì ìœ¼ë¡œ ê´€ì°°í•´ì•¼ í•  ì§€í‘œë“¤)

            ## âš ï¸ ë©´ì±…ì¡°í•­
            ë³¸ ë¶„ì„ì€ íˆ¬ìž ì°¸ê³ ìš©ì´ë©°, ìµœì¢… íˆ¬ìž ê²°ì •ì€ ë³¸ì¸ì˜ ì±…ìž„ìž…ë‹ˆë‹¤.
            """,
            agent=self.investment_advisor(),
        )

    def crew(self) -> Crew:
        return Crew(
            agents=[
                self.news_analyst(),
                self.technical_analyst(),
                self.investment_advisor()
            ],
            tasks=[
                self.analyze_news_sentiment_task(),
                self.technical_analysis_task(),
                self.final_investment_decision_task()
            ],
            process=Process.sequential,
            verbose=True,
            # memory=True,
            # output_log_file="investment_analysis_log.txt"
        )